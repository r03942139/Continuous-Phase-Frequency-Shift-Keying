clc;close all;clear all;
n=10;
b=round(rand(1,n*6));
sd=.3;
data=zeros(1,n);
t=zeros(2,2,2,2,2,2);
t(1,1,1,1,1,1)=-7+7*j;
t(1,1,1,1,1,2)=-5+7*j;
t(1,1,1,1,2,2)=-3+7*j;
t(1,1,1,1,2,1)=-1+7*j;
t(1,1,1,2,2,1)= 1+7*j;
t(1,1,1,2,2,2)= 3+7*j;
t(1,1,1,2,1,2)= 5+7*j;
t(1,1,1,2,1,1)= 7+7*j;

t(1,1,2,1,1,1)=-7+5*j;
t(1,1,2,1,1,2)=-5+5*j;
t(1,1,2,1,2,2)=-3+5*j;
t(1,1,2,1,2,1)=-1+5*j;
t(1,1,2,2,2,1)= 1+5*j;
t(1,1,2,2,2,2)= 3+5*j;
t(1,1,2,2,1,2)= 5+5*j;
t(1,1,2,2,1,1)= 7+5*j;

t(1,2,2,1,1,1)=-7+3*j;
t(1,2,2,1,1,2)=-5+3*j;
t(1,2,2,1,2,2)=-3+3*j;
t(1,2,2,1,2,1)=-1+3*j;
t(1,2,2,2,2,1)= 1+3*j;
t(1,2,2,2,2,2)= 3+3*j;
t(1,2,2,2,1,2)= 5+3*j;
t(1,2,2,2,1,1)= 7+3*j;

t(1,2,1,1,1,1)=-7+j;
t(1,2,1,1,1,2)=-5+j;
t(1,2,1,1,2,2)=-3+j;
t(1,2,1,1,2,1)=-1+j;
t(1,2,1,2,2,1)= 1+j;
t(1,2,1,2,2,2)= 3+j;
t(1,2,1,2,1,2)= 5+j;
t(1,2,1,2,1,1)= 7+j;

t(2,2,1,1,1,1)=-7-j;
t(2,2,1,1,1,2)=-5-j;
t(2,2,1,1,2,2)=-3-1i;
t(2,2,1,1,2,1)=-1-j;
t(2,2,1,2,2,1)= 1-1i;
t(2,2,1,2,2,2)= 3-j;
t(2,2,1,2,1,2)= 5-j;
t(2,2,1,2,1,1)= 7-j;

t(2,2,2,1,1,1)=-7-3*j;
t(2,2,2,1,1,2)=-5-3*j;
t(2,2,2,1,2,2)=-3-3*j;
t(2,2,2,1,2,1)=-1-3*j;
t(2,2,2,2,2,1)= 1-3*j;
t(2,2,2,2,2,2)= 3-3*j;
t(2,2,2,2,1,2)= 5-3*j;
t(2,2,2,2,1,1)= 7-3*j;

t(2,1,2,1,1,1)=-7-5*j;
t(2,1,2,1,1,2)=-5-5*j;
t(2,1,2,1,2,2)=-3-5*j;
t(2,1,2,1,2,1)=-1-5*j;
t(2,1,2,2,2,1)= 1-5*j;
t(2,1,2,2,2,2)= 3-5*j;
t(2,1,2,2,1,2)= 5-5*j;
t(2,1,2,2,1,1)= 7-5*j;

t(2,1,1,1,1,1)=-7-7*j;
t(2,1,1,1,1,2)=-5-7*j;
t(2,1,1,1,2,2)=-3-7*j;
t(2,1,1,1,2,1)=-1-7*j;
t(2,1,1,2,2,1)= 1-7*j;
t(2,1,1,2,2,2)= 3-7*j;
t(2,1,1,2,1,2)= 5-7*j;
t(2,1,1,2,1,1)= 7-7*j;
for k=1:n
    x=b(6*(k-1)+1:k*6)+1;
    data(k)=t(x(1),x(2),x(3),x(4),x(5),x(6));
end
figure(1); plot(data,'*')
%% preamble
short = sign(randn(1,16));
long =  sign(randn(1,32));
data = [short short short short short long data];
%% Up-sampling
d = 4;
data_samp = zeros(1,(n+16*5+32)*4);
data_samp(1:d:end) = data;
%% Pulse-shaping
h = srrc_fn(0.3,4,5);
pulse_shape = conv(data_samp,h);
%% channel
rn = [0.5*randn(1,500) pulse_shape];
noise = 0.01*randn(1,length(rn)) + j*0.01*randn(1,length(rn));
r = rn + noise;
%% Packet detection
D = 16*d;
L = 16*d;

cn = zeros(1,length(r));
pn = zeros(1,length(r));

for i = 1:L
    cn = cn + [r(i:end) zeros(1,i-1)].*conj([r(i+D:end) zeros(1,i-1+D)]);
    pn = pn + [r(i+D:end) zeros(1,i-1+D)].*conj([r(i+D:end) zeros(1,i-1+D)]);
end

mn = (abs(cn).^2)./((pn.^2)+0.00001);
figure(2);stem(mn)
%% CFO
%% symbol timing
%% Matchimg/down sample
%% channel/Equal
%% Detection



